import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Read the results generated by run.js
const resultsPath = path.join(__dirname, 'results.json');
if (!fs.existsSync(resultsPath)) {
  console.error("âŒ results.json not found! Run 'node run.js' first.");
  process.exit(1);
}

const data = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));

// Process data for Chart.js
const labels = data.map(r => r.name);
const tjsDev = data.map(r => parseInt(r.typedjs.dev.time));
const tjsProd = data.map(r => parseInt(r.typedjs.prod.time));
const tsTotal = data.map(r => parseInt(r.typescript.totalTime));

const htmlTemplate = `
<!DOCTYPE html>
<html>
<head>
    <title>TypedJS Benchmark Report</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 40px; background: #f9f9f9; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        .summary { margin-bottom: 30px; border-left: 5px solid #4bc0c0; padding-left: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸš€ TypedJS vs TypeScript</h1>
        <div class="summary">
            <p><strong>Metric:</strong> Total turnaround time (Compilation + Execution) in <strong>milliseconds</strong>.</p>
            <p>Lower is better. Results based on your local system benchmark.</p>
        </div>
        <canvas id="benchmarkChart"></canvas>
    </div>

    <script>
        const ctx = document.getElementById('benchmarkChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ${JSON.stringify(labels)},
                datasets: [
                    { label: 'TypedJS (Dev)', data: ${JSON.stringify(tjsDev)}, backgroundColor: '#ffce56' },
                    { label: 'TypedJS (Prod)', data: ${JSON.stringify(tjsProd)}, backgroundColor: '#4bc0c0' },
                    { label: 'TypeScript (Total)', data: ${JSON.stringify(tsTotal)}, backgroundColor: '#36a2eb' }
                ]
            },
            options: {
                responsive: true,
                scales: { y: { beginAtZero: true, title: { display: true, text: 'Time (ms)' } } },
                plugins: {
                    title: { display: true, text: 'Developer Velocity: Save to Run Time' }
                }
            }
        });
    </script>
</body>
</html>
`;

fs.writeFileSync(path.join(__dirname, 'benchmark_report.html'), htmlTemplate);
console.log('âœ… Visual report generated: benchmarks/benchmark_report.html');